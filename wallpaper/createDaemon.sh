#!/bin/bash

#All the stderr is redirected in error.log
exec 2>> errorDaemon.log
logger -t configconfig gnzofn foze,f
function help {
	echo -e "\n"
	echo -e "\t\033[34;1mcreateDaemon.sh \e[0m : allows you to automatically change the wallpaper every 30min.
	\e[1mOPTIONS\e[0m :
	-h : \tasks for help.
	-i : \tinstalls the daemon.
	-s : \tstarts the daemon.
	-u : \tuninstalls the daemon.
	-b : \tstops the daemon."
	echo -e "\n"
}


while getopts ":hisub" option
do
	case ${option} in 
		h)
			help
			exit 0
		;;
		i)
			moi=$(whoami)
			#Create the service file
			echo "[Unit]
			Description=Daemon to change the wallpaper every 30min
			[Service]
			Type=simple
			User=$moi
			ExecStart=/bin/bash /opt/changingWallpaper.sh
			Restart=always
			[Install]
			WantedBy=multi-user.target" > /tmp/changinWall.service

			#According to FSH, best place to put the .sh
			sudo cp ~/changingWallpaper.sh /opt/ 
			#Copy the service file in system
			sudo cp /tmp/changinWall.service /etc/systemd/system/
			#Remove the service file in tmp
			sudo rm /tmp/changinWall.service
			#Reload the daemons
			sudo systemctl daemon-reload
		;;
		s)
			#Start the Daemon if it exists
			sudo systemctl start changinWall 
			launchedOrNot=$(sudo systemctl status changinWall | grep -ic "loaded")
			if [ $launchedOrNot -ge 1 ]
			then
				logger -t createDaemon  "Daemon successfully launched"
			fi
		;;
		u)
			sudo systemctl stop changinWall
			sudo rm /opt/changingWallpaper.sh
			sudo rm /etc/systemd/system/changinWall.service
			sudo systemctl daemon-reload
			sudo systemctl status changinWall > test.txt 2>&1
			uninstalledOrNot=$(grep -ic "could not be found" test.txt)
			if [ $uninstalledOrNot -ge 1 ]
			then
				logger -t createDaemon "Daemon successfully uninstalled."
			fi
			rm test.txt
		;;
		b)
			sudo systemctl stop changinWall
			stoppedOrNot=$(sudo systemctl status changinWall | grep -ic "inactive")
			if [ $stoppedOrNot -ge 1 ]
			then
				logger -t createDaemon "Daemon successfully stopped."
			fi
		;;
		\?)
			echo "I don't know what to do with [$OPTARG]. Please, ask for help."
			break
		;;
	esac

done
