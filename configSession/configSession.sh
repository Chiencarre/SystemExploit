#!/bin/bash

function changeBackground {
	xfconf-query -c xfce4-desktop -p /backdrop/screen0/monitor0/workspace0/last-image --set $1 
	#Wallpaper is adjusted to the window size
	xfconf-query -c xfce4-desktop -p /backdrop/screen0/monitor0/workspace0/image-style --set 4
}

choice=$(whiptail --title "Session Configuration" --menu "Choose your prefered configuration." 15 80 3 \
	"1" "Train - Neutral wallpaper and Libre Office opens." \
	"2" "Professional - Professional wallpaper and the encrypted partition opens." \
	"3" "Personal - Fun wallpaper and Firefox opens." 3>&1 1>&2 2>&3)

#If the user has choosen an item
if [ $? -eq 0 ]
then
	case $choice in 
			#Train case
			1)
				#Change background
				pathBackground=/usr/share/xfce4/backdrops/train.jpg
				changeBackground $pathBackground
				#Opening LibreOffice
				/usr/bin/libreoffice
				logger -t configSession "User chose the train configuration."
			;;
			#Pro case
			2)
				#Change background
				pathBackground=/usr/share/xfce4/backdrops/pro.jpg
				changeBackground $pathBackground

				#Open encrypted partition
				partitionPath=$(whiptail --inputbox "Opening partition." 8 78  --title "Please type in the path of your encrypted partition." 3>&1 1>&2 2>&3)
				#Check if the user has entered sth or has exited
				if [ $? -eq 0 ]
				then 
					#Check if the path exists
					if [[ -e "$partitionPath" ]]
					then
						#Get password
						passw=$(whiptail --passwordbox "Please type in the password of you encrypted partition." 8 78 --title "Password for $partitionPath" 3>&1 1>&2 2>&3)
						if [ $? -eq 0 ]
						then
							#Open partition using password
							echo $passw | sudo cryptsetup luksOpen "$partitionPath" encryptedP
							#Create folder for partition in /media (in order to be practicle for the user. THANK YOU PABLO)
							sudo mkdir /media/encryptedP
							#Mount the partition
							sudo mount $partitionPath /media/encryptedP
							#Open the partition
							thunar /media/encryptedP
						fi
					else
						logger -t configSession "Partition path does not exist."
						exit 1
					fi
				else
					logger -t configSession "User aborted the mission."
					exit 1
				fi
				logger -t configSession "User chose the professional configuration."
			;;
			#Perso case
			3)
				choice2=$(whiptail --title "Last question." --menu "Cat or dog?" 15 70 3 \
				"1" "Cat"\
				"2" "Dog" 3>&1 1>&2 2>&3)
				if [ $? -eq 0 ]
				then
					case $choice2 in
							1)
								#Change background
								pathBackground=/usr/share/xfce4/backdrops/cat.jpg
								changeBackground $pathBackground
							;;
							2)
								#Change background
								pathBackground=/usr/share/xfce4/backdrops/dog.jpg
								changeBackground $pathBackground 
							;;
					esac
				else
					logger -t configSession "User aborted the mission."
					exit 1
				fi

				firefox
				logger -t configSession "User chose the personal configuration."
			;;
	esac
else
	logger -t configSession "User aborted the mission."
	exit 1
fi
exit 0
